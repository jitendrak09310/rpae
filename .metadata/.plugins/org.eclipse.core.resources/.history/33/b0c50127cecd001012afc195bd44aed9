package com.rpae.alert_service.service;

import java.util.List;

import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpMethod;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.rpae.alert_service.DTOs.PriceDTO;
import com.rpae.alert_service.DTOs.UserAlertDTO;
import com.rpae.alert_service.model.Alert;
import com.rpae.alert_service.repository.AlertRepository;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class AlertService {

	private final AlertRepository repo;
	private final RestTemplate restTemplate;

	public void checkAlerts(PriceDTO priceDto) {
		List<UserAlertDTO> alerts = restTemplate
				.exchange("http://localhost:8086/user-alerts/getAlerts?symbol=" + priceDto.getSymbol(), HttpMethod.GET,
						null, new ParameterizedTypeReference<List<UserAlertDTO>>() {
						})
				.getBody();

		for (UserAlertDTO alert : alerts) {
			if (alert.getUpperLimit() != null && priceDto.getPrice() > alert.getUpperLimit()) {
				log.info("Alert : Upper limit crossed for user :" + alert.getUserEmail());
				notifyUser(alert.getUserEmail(), priceDto);
				restTemplate.postForObject("http://localhost:8083/notify/send", priceDto, void.class);
			}
		}
	}

	public void notifyUser(String userEmail, PriceDTO priceDto) {

	}

	public Alert createAlert(Alert alert) {
		return repo.save(alert);
	}

	public List<Alert> getAll() {
		return repo.findAll();
	}

}
