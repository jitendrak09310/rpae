package com.rpae.fetcher_service.service;

import java.util.List;

import org.jspecify.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.rpae.fetcher_service.DTOs.SourceDTO;
import com.rpae.fetcher_service.client.SourceClient;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class FetcherService {

	private final RestTemplate restTemplate;
	private final SourceClient sourceClient;
	private static final Logger log = LoggerFactory.getLogger(FetcherService.class);

	public void fetchAll() {

		List<SourceDTO> activeSources = sourceClient.getActiveSources();

		for (SourceDTO sourceDto : activeSources) {

			try {
				log.info("Fetched URL from DB: '{}'", sourceDto.getUrl());
				@Nullable
				String rawJson = restTemplate.getForObject(sourceDto.getUrl(), String.class);
				log.info(rawJson);

				restTemplate.getForObject("http://localhost:8082/process?sourceName=" + rawJson.getName(), rawJson,
						String.class);

			} catch (Exception e) {
				e.printStackTrace();
			}

		}

	}
}
